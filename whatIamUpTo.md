Beware, this file loses content as I get stuff done, anything worth remembering becomes comments on the code. 

# Locally

- [x] Design cloud
- [x] Recreate locally
- [x] Add Talos OS to it
- [x] Add Flux
- [x] Run podinfo as a template for everything else

## On his cloud
- [x] Add Talos to the current cloud using his image
	- [x] Added label controlplane
- [x] Assign private IPs to simplify Talos Bootstraping
- [x] Bootstrap Talos directly from Terraform
- [x] Add Flux
- [x] Add anything using Terraform AND Flux like Podinfo
- [ ] Add an Traefik as Ingress
- [ ] Add Cert-Manager
- [ ] Add CSI as Storage classes.
- [ ] Add Velero

## Talos Boostrapping

It's all done mostly in talos-config.tf

#### Configuring talosctl

To use the talosconfig generated by Terraform use

```sh
terraform output -json talos_talosconfig | jq -r . > /tmp/talosconfig  && export TALOSCONFIG=/tmp/talosconfig
```

#### Configuring kubectl

Use this so you can use kubectl and the common alias you've always used

```bash
talosctl kubeconfig /tmp/kubeconfig && export KUBECONFIG=/tmp/kubeconfig && alias k=kubectl
```

Now to simply check the nodes with full details

```sh
kubectl get nodes -o wide
```

You can see the dashboard either by console into any server from Hetzner cloud or simply

```sh
talosctl dashboard
```

# Adding Flux & Bootstrapping it

The most **important** part of Flux is that the kube credentials passed from Talos need to be byte64decoded and **that's nowhere in the docs**

Interestingly enough if you destroy the infrastructure, the folder of Flux in the repo you named gets destroyed too, not the entire repo. So you're suppose to use Terraform to start a Flux deployment with some initial stuff and then let it run. If you destroy the deployment TF assumes you don't need that folder either. 

### Credentials for Github

These are described in variables.tf and added out of the repo in terraform.tfvars

### Manually adding Flux sources

```sh
flux create source git podinfo \
  --url=https://github.com/stefanprodan/podinfo \
  --branch=master \
  --interval=1m \
  --export > ./clusters/my-cluster/podinfo-source.yaml
```

Then commit and push, Flux will update it. In k9s you can find it as GitRepository

### Manually adding kustomizations

```sh
flux create kustomization podinfo \
  --target-namespace=default \
  --source=podinfo \
  --path="./kustomize" \
  --prune=true \
  --wait=true \
  --interval=30m \
  --retry-interval=2m \
  --health-check-timeout=3m \
  --export > ./clusters/my-cluster/podinfo-kustomization.yaml
Instructions: https://fluxcd.io/flux/get-started/
```

Commit and push again. 

Even though you don't have an ingress yet you can check podinfo with 

```sh
kubectl port-forward service/podinfo 9898:9898 
```

Check errors with

```sh
flux events
```

Saves you from using K9s
# Adding ingress

Stephen ingress of choice is my favourite: Traefik

Ingress won't work without persistent volumes because Traefik needs some PVCs. Its pod is stuck because of this. Remove persistent=true and fixed. 


# Issues

* Notice there's no ingress and no storage classes!
* The first time it is run obviously Flux git config (flux_bootstrap_git) won't work because it takes a while for Talos to bootstrap. But once that first run goes you have to wait a little for all servers (console log into any cplane) to see them all ready. **THEN** you can re-run terraform apply. 