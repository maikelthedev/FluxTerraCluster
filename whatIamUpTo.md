Beware, this file loses content as I get stuff done, anything worth remembering becomes comments on the code. 

# Locally
- [x] Design cloud
- [x] Recreate locally
- [x] Add Talos OS to it
- [x] Add Flux
- [x] Run podinfo as a template for everything else

## On his cloud
- [x] Add Talos to the current cloud using his image
	- [x] Added label controlplane
- [x] Assign private IPs to simplify Talos Bootstraping
- [x] Bootstrap Talos directly from Terraform
- [ ] Add Flux
- [ ] Add CSI

## Talos Boostrapping

It's all done mostly in talos-config.tf

#### Configuring talosctl

To use the talosconfig generated by Terraform use

```sh
terraform output -json talos_talosconfig | jq -r . > /tmp/talosconfig  
export TALOSCONFIG=/tmp/talosconfig
```

#### Configuring kubectl

Use this so you can use kubectl and the common alias you've always used

```bash
talosctl kubeconfig /tmp/kubeconfig
export KUBECONFIG=/tmp/kubeconfig
alias k=kubectl
```

Now to simply check the nodes with full details

```sh
kubectl get nodes -o wide
```


Notice there's no ingress and no storage classes!

### Important

For flux you need

```sh
export GITHUB_TOKEN=<your-token>
export GITHUB_USER=<your-username>
```

Instructions: https://fluxcd.io/flux/get-started/

Installing FLUx

```sh
kubectl apply -f https://github.com/fluxcd/flux2/releases/latest/download/install.yaml
```
NOw plug it to your github repo

Beware Flux will assume you have a valid kubeconfig so before do:

```sh
 export KUBECONFIG=/home/maikel/code/clients/stephen_newey/FluxTerraCluster/kubeconfig
```


if flux pre --check doesn't pass then there's an issue connecting to the cluster. 

```sh
export GITHUB_TOKEN="...."
export GITHUB_USER=maikelthedev

flux bootstrap github \
  --token-auth \
  --owner=maikelthedev \
  --repository=fleet-infra \
  --branch=main \
  --path=clusters/my-cluster \
  --personal
```

## Now with Flux installed

You still don't have an ingress but could use Flux to install it. 

Notice that Stephen does not ask for an ingress though. 

From the folder of fleet-infra do this

```sh
flux create source git podinfo \
  --url=https://github.com/stefanprodan/podinfo \
  --branch=master \
  --interval=1m \
  --export > ./clusters/my-cluster/podinfo-source.yaml
```

Then commit and push. 

You still have not deployed it, now do.

```sh
flux create kustomization podinfo \
  --target-namespace=default \
  --source=podinfo \
  --path="./kustomize" \
  --prune=true \
  --wait=true \
  --interval=30m \
  --retry-interval=2m \
  --health-check-timeout=3m \
  --export > ./clusters/my-cluster/podinfo-kustomization.yaml
```

Commit and push again

Now in theory you have Flux and podinfo all configured

## Let's configure an ingress to actually see if it works

Install helm https://helm.sh/docs/intro/install/

Add the traefik repo

https://platform9.com/learn/v1.0/tutorials/traefik-ingress

Created kubelb.mkl.lol as acces to load balancer on D.O. 

To use the talosconfig from the Terraform use

```sh
terraform output -json talos_talosconfig | jq -r . > talosconfig  
export TALOSCONFIG=$(pwd)/talosconfig
```

